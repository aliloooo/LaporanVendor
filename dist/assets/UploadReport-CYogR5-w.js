import{j as e,s as h}from"./index-CT63F8Oz.js";import{r as m}from"./vendor-C2YDr15k.js";import{u as _}from"./data-CpkYhZGa.js";import{g as E,k as F,C as k,L as N,f as D}from"./ui-BsoBaXac.js";import{c as L,d as T}from"./dateHelper-uiqc6hDl.js";import"./toDate-SX-ecmdR.js";const q=5*1024*1024,U=["application/pdf","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","application/vnd.ms-excel"],R=({vendors:o,reportTypes:r,onSubmit:i,isSubmitting:a,success:l})=>{const{register:d,handleSubmit:b,formState:{errors:s},watch:u,reset:g}=_(),[j,n]=m.useState(""),c=u("file"),p=t=>(n(""),t?t.size>q?(n("File size exceeds 5MB limit"),!1):U.includes(t.type)?!0:(n("Invalid file type. Only PDF and Excel (.xlsx, .xls) are allowed"),!1):(n("File is required"),!1)),x=async t=>{const f=t.file[0];p(f)&&(await i({...t,file:f}),l&&g())};return l?e.jsxs("div",{className:"bg-white rounded-xl shadow-sm border border-green-200 p-8 text-center flex flex-col items-center",children:[e.jsx("div",{className:"w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mb-4",children:e.jsx(E,{className:"w-8 h-8 text-green-600"})}),e.jsx("h3",{className:"text-xl font-bold text-slate-900 mb-2",children:"Upload Successful"}),e.jsx("p",{className:"text-slate-500 mb-6",children:"Your report has been successfully submitted and recorded."}),e.jsx("button",{onClick:()=>window.location.reload(),className:"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium transition-colors",children:"Upload Another Report"})]}):e.jsx("form",{onSubmit:b(x),className:"bg-white rounded-xl shadow-sm border border-slate-200 p-8",children:e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:"Nama Vendor"}),e.jsxs("select",{...d("vendor_id",{required:"Vendor is required"}),className:"w-full rounded-lg border border-slate-300 px-4 py-2.5 bg-white text-slate-900 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-shadow",children:[e.jsx("option",{value:"",children:"-- Pilih Vendor --"}),o.map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))]}),s.vendor_id&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:s.vendor_id.message})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:"Jenis Laporan"}),e.jsxs("select",{...d("report_type_id",{required:"Report Type is required"}),className:"w-full rounded-lg border border-slate-300 px-4 py-2.5 bg-white text-slate-900 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-shadow",children:[e.jsx("option",{value:"",children:"-- Pilih Jenis Laporan --"}),r.map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))]}),s.report_type_id&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:s.report_type_id.message})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:"Tanggal Laporan"}),e.jsx("input",{type:"date",defaultValue:new Date().toISOString().split("T")[0],min:new Date().toISOString().split("T")[0],...d("report_month",{required:"Tanggal is required",validate:t=>{const f=new Date(t),w=new Date;return w.setHours(0,0,0,0),f.setHours(0,0,0,0),f>=w||"Tanggal laporan tidak boleh hari sebelumnya"}}),className:"w-full rounded-lg border border-slate-300 px-4 py-2.5 bg-white text-slate-900 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-shadow"}),s.report_month&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:s.report_month.message})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:"File Laporan"}),e.jsx("div",{className:"mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-slate-300 border-dashed rounded-xl hover:border-blue-400 transition-colors bg-slate-50",children:e.jsx("div",{className:"space-y-1 text-center",children:c&&c.length>0?e.jsxs("div",{className:"flex flex-col items-center space-y-2",children:[e.jsx(F,{className:"mx-auto h-12 w-12 text-blue-500"}),e.jsx("div",{className:"text-sm text-slate-900 font-medium",children:c[0].name}),e.jsxs("p",{className:"text-xs text-slate-500",children:[(c[0].size/(1024*1024)).toFixed(2)," MB"]})]}):e.jsxs(e.Fragment,{children:[e.jsx(k,{className:"mx-auto h-12 w-12 text-slate-400"}),e.jsxs("div",{className:"flex text-sm text-slate-600 justify-center",children:[e.jsxs("label",{htmlFor:"file-upload",className:"relative cursor-pointer bg-white rounded-md font-medium text-blue-600 hover:text-blue-500 focus-within:outline-none focus-within:ring-2 focus-within:ring-offset-2 focus-within:ring-blue-500",children:[e.jsx("span",{children:"Upload a file"}),e.jsx("input",{id:"file-upload",...d("file",{required:"File is required"}),type:"file",className:"sr-only",accept:".pdf, .xlsx, .xls"})]}),e.jsx("p",{className:"pl-1",children:"or drag and drop"})]}),e.jsx("p",{className:"text-xs text-slate-500",children:"PDF, XLSX up to 5MB"})]})})}),(s.file||j)&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:j||s.file?.message})]}),e.jsx("div",{className:"pt-4",children:e.jsx("button",{type:"submit",disabled:a,className:"w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-70 disabled:cursor-not-allowed transition-colors",children:a?e.jsxs(e.Fragment,{children:[e.jsx(N,{className:"w-5 h-5 animate-spin mr-2"}),"Uploading Report..."]}):"Submit Report"})})]})})},C=async o=>{try{const{vendor_id:r,report_type_id:i,report_month:a,file:l}=o,{data:d,error:b}=await h.from("report_types").select("*").eq("id",i).single();if(b)throw b;const{data:s,error:u}=await h.from("vendors").select("name").eq("id",r).single();if(u)throw u;const g=l.name.split(".").pop(),j=s.name.replace(/[^a-z0-9]/gi,"_").toLowerCase(),[n,c]=a.split("-"),p=`${j}/${n}/${c}/${Date.now()}-${l.name.replace(/[^a-z0-9.]/gi,"_")}`,{data:x,error:t}=await h.storage.from("vendor-reports").upload(p,l);if(t)throw t;const{data:f}=h.storage.from("vendor-reports").getPublicUrl(p),w=f.publicUrl,v=L(a,d),S=T(!0,v),{error:y}=await h.from("report_uploads").insert([{vendor_id:r,report_type_id:i,report_month:a,file_url:w,file_name:l.name,status:S}]);if(y)throw y;return{success:!0}}catch(r){throw console.error("Error during upload:",r),r}},P=async()=>{try{const{data:o,error:r}=await h.from("vendors").select("id, name").order("name");if(r)throw r;const{data:i,error:a}=await h.from("report_types").select("id, name").order("id");if(a)throw a;return{vendors:o,reportTypes:i}}catch(o){throw console.error("Error fetching form options:",o),o}},A=()=>{const[o,r]=m.useState([]),[i,a]=m.useState([]),[l,d]=m.useState(!0),[b,s]=m.useState(!1),[u,g]=m.useState(null),[j,n]=m.useState(!1);m.useEffect(()=>{(async()=>{try{const{vendors:x,reportTypes:t}=await P();r(x),a(t)}catch{g("Gagal memuat data master. Silakan refresh halaman.")}finally{d(!1)}})()},[]);const c=async p=>{s(!0),g(null),n(!1);try{await C(p),n(!0)}catch(x){g(x.message||"Terjadi kesalahan saat mengunggah laporan.")}finally{s(!1)}};return l?e.jsxs("div",{className:"flex flex-col items-center justify-center min-h-[400px] text-slate-500",children:[e.jsx(N,{className:"w-8 h-8 animate-spin mb-4 text-blue-600"}),e.jsx("p",{children:"Memuat formulir..."})]}):e.jsxs("div",{className:"space-y-6 max-w-2xl mx-auto",children:[e.jsxs("div",{className:"flex flex-col space-y-2",children:[e.jsx("h1",{className:"text-2xl font-bold tracking-tight text-slate-900",children:"Upload Laporan Rutin"}),e.jsx("p",{className:"text-slate-500",children:"Silakan lengkapi form di bawah ini dan lampirkan dokumen laporan (PDF/Excel maks 5MB)."})]}),u&&e.jsxs("div",{className:"bg-red-50 border-l-4 border-red-500 p-4 rounded-r-lg flex items-start",children:[e.jsx(D,{className:"w-5 h-5 text-red-500 mr-3 shrink-0 mt-0.5"}),e.jsx("p",{className:"text-sm text-red-700",children:u})]}),e.jsx(R,{vendors:o,reportTypes:i,onSubmit:c,isSubmitting:b,success:j})]})};export{A as default};
